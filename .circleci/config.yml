version: 2.1  
jobs:
  develop_deploy:
    docker:
      - image: cimg/node:16.19.1-browsers
        environment:
          POSTGRES_USER: postgres
          NODE_ENV: test
      - image: circleci/postgres:9.5-alpine
        environment:
          POSTGRES_DB: analytics-api-test
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            - v1-dependencies-
      
      - run:
          name: install dependencies
          command: npm install
      
      - save_cache:
          paths:
            - ./node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      
      - run:
          name: run tests
          command: npm test
      
      - run:
          name: Replace Data URL in manifest.yml file when deploying to develop
          command: |
              sed -i 's@name: analytics-reporter-api@name: analytics-reporter-api-develop@g' manifest.yml
              sed -i 's@- analytics-reporter-database@- analytics-reporter-database-develop@g' manifest.yml
              mv manifest.yml manifest.yml.src
              envsubst < manifest.yml.src > manifest.yml

      - run:
          name: Run sed on entrypoint.sh when deploying to develop
          command: |
              sed -i 's@NEW_RELIC_APP_NAME="analytics-reporter-api"@NEW_RELIC_APP_NAME="analytics-reporter-api-develop"@g' entrypoint.sh

      - run:
          name: Delete Knexfile.js and drop sufffix on Knexfile.js.cloudgov
          command: |
              rm knexfile.js
              mv knexfile.js.cloudgov knexfile.js

      - run:   
          name: Install CF CLI
          command: |
              sudo curl -v -L -o cf8-cli-installer_8.7.4_x86-64.deb 'https://packages.cloudfoundry.org/stable?release=debian64&version=8.7.4'
              sudo dpkg -i cf8-cli-installer_8.7.4_x86-64.deb
      
      - run:
          name: deploy
          command: |
              set -e
              # Log into cloud.gov
              cf api api.fr.cloud.gov
              cf login -u $CF_USERNAME_DEV -p $CF_PASSWORD_DEV -o gsa-opp-analytics -s analytics-dev
              cat manifest.yml
              cf push -f "./manifest.yml"
              cf logout

workflows:
  develop_workflow:
    jobs: 
      - develop_deploy:
          filters:
            branches:
              only:
                - develop

  # staging:
    # jobs: 
      # # - staging_deploy:
      #     filters:
      #       branches:
      #         only:
      #           - staging
                  
  # main_workflow:
  #   jobs: 
  #     - main_deploy:
  #         filters:
  #           branches:
  #             only:
  #               - master
  #
